#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
åˆ›å»ºå®Œæ•´çš„åˆ†å‘åŒ…
"""

import os
import shutil
import zipfile
from pathlib import Path
import datetime

def create_distribution():
    """åˆ›å»ºå®Œæ•´çš„åˆ†å‘åŒ…"""
    print("åˆ›å»ºå®Œæ•´çš„åˆ†å‘åŒ…...")
    
    # æ£€æŸ¥exeæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    exe_file = Path("dist/xImageDuplicateChecker.exe")
    if not exe_file.exists():
        print("âœ— æ‰¾ä¸åˆ°exeæ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ build_exe.py")
        return False
    
    # åˆ›å»ºåˆ†å‘ç›®å½•
    dist_name = f"xImageDuplicateChecker_v1.0_{datetime.datetime.now().strftime('%Y%m%d')}"
    dist_dir = Path(f"release/{dist_name}")
    dist_dir.mkdir(parents=True, exist_ok=True)
    
    print(f"åˆ›å»ºåˆ†å‘ç›®å½•: {dist_dir}")
    
    # å¤åˆ¶exeæ–‡ä»¶
    shutil.copy2(exe_file, dist_dir / "xImageDuplicateChecker.exe")
    print("âœ“ å¤åˆ¶exeæ–‡ä»¶")
    
    # å¤åˆ¶DLLæ–‡ä»¶
    dll_files = [
        "hash_algorithms.dll",
        "opencv_videoio_ffmpeg4120_64.dll", 
        "opencv_world4120.dll"
    ]
    
    for dll_file in dll_files:
        if os.path.exists(dll_file):
            shutil.copy2(dll_file, dist_dir)
            print(f"âœ“ å¤åˆ¶ {dll_file}")
        else:
            print(f"âš  æœªæ‰¾åˆ° {dll_file}")
    
    # å¤åˆ¶cpp_hash_libç›®å½•ä¸­çš„DLL
    cpp_lib_dir = Path("cpp_hash_lib")
    if cpp_lib_dir.exists():
        target_cpp_dir = dist_dir / "cpp_hash_lib"
        target_cpp_dir.mkdir(exist_ok=True)
        
        for dll_file in cpp_lib_dir.glob("*.dll"):
            shutil.copy2(dll_file, target_cpp_dir)
            print(f"âœ“ å¤åˆ¶ {dll_file} åˆ° cpp_hash_lib")
    
    # åˆ›å»ºè¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
    create_detailed_readme(dist_dir)
    
    # å¤åˆ¶è®¸å¯è¯æ–‡ä»¶
    if os.path.exists("LICENSE"):
        shutil.copy2("LICENSE", dist_dir)
        print("âœ“ å¤åˆ¶è®¸å¯è¯æ–‡ä»¶")
    
    # åˆ›å»ºZIPå‹ç¼©åŒ…
    zip_file = Path(f"release/{dist_name}.zip")
    create_zip_package(dist_dir, zip_file)
    
    print(f"\nâœ“ åˆ†å‘åŒ…åˆ›å»ºå®Œæˆï¼")
    print(f"ç›®å½•ç‰ˆæœ¬: {dist_dir}")
    print(f"å‹ç¼©åŒ…ç‰ˆæœ¬: {zip_file}")
    print(f"\nå¯ä»¥å°† {zip_file} åˆ†äº«ç»™å…¶ä»–ç”¨æˆ·")
    
    return True

def create_detailed_readme(dist_dir):
    """åˆ›å»ºè¯¦ç»†çš„ä½¿ç”¨è¯´æ˜"""
    readme_content = f"""
# xImageDuplicateChecker v1.0 - é‡å¤å›¾ç‰‡æ£€æµ‹å·¥å…·

## ğŸ“‹ å…³äº
è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„é‡å¤å›¾ç‰‡æ£€æµ‹å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æ‚¨å¿«é€Ÿæ‰¾åˆ°è®¡ç®—æœºä¸­çš„é‡å¤å›¾ç‰‡æ–‡ä»¶ã€‚

## ğŸš€ ä¸»è¦åŠŸèƒ½
- **å¤šç§æ£€æµ‹ç®—æ³•**: æ”¯æŒdHashã€pHashã€aHashç­‰å¤šç§å›¾ç‰‡å“ˆå¸Œç®—æ³•
- **æ—‹è½¬æ£€æµ‹**: èƒ½å¤Ÿè¯†åˆ«æ—‹è½¬åçš„ç›¸åŒå›¾ç‰‡
- **ç¼©æ”¾æ£€æµ‹**: æ”¯æŒæ£€æµ‹ä¸åŒå°ºå¯¸çš„ç›¸åŒå›¾ç‰‡
- **å¢å¼ºç›¸ä¼¼åº¦æ£€æµ‹**: ä½¿ç”¨å…ˆè¿›ç®—æ³•æ£€æµ‹ç»è¿‡å˜æ¢çš„ç›¸ä¼¼å›¾ç‰‡
- **çº¯è‰²å›¾ç‰‡æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å’Œæ ‡è®°çº¯è‰²æˆ–æ¥è¿‘çº¯è‰²çš„å›¾ç‰‡
- **æ‰¹é‡å¤„ç†**: æ”¯æŒé€’å½’æ‰«ææ•´ä¸ªç›®å½•æ ‘
- **ç›´è§‚ç•Œé¢**: å‹å¥½çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œæ“ä½œç®€å•
- **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç•Œé¢
- **å¤šç§æ ¼å¼**: æ”¯æŒJPGã€PNGã€BMPã€GIFã€TIFFç­‰å¸¸è§å›¾ç‰‡æ ¼å¼

## ğŸ’» ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 7/8/10/11 (64ä½)
- **å†…å­˜**: å»ºè®®è‡³å°‘ 4GB RAM
- **ç£ç›˜ç©ºé—´**: è‡³å°‘ 100MB å¯ç”¨ç©ºé—´
- **å¤„ç†å™¨**: æ”¯æŒSSE2æŒ‡ä»¤é›†çš„å¤„ç†å™¨

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨ç¨‹åº
åŒå‡» `xImageDuplicateChecker.exe` å¯åŠ¨ç¨‹åº

### 2. æ‰«æå›¾ç‰‡
1. åˆ‡æ¢åˆ°"æ‰«æä¸æ£€æµ‹"æ ‡ç­¾é¡µ
2. ç‚¹å‡»"é€‰æ‹©ç›®å½•"æŒ‰é’®ï¼Œé€‰æ‹©è¦æ‰«æçš„æ–‡ä»¶å¤¹
3. æ ¹æ®éœ€è¦è°ƒæ•´æ£€æµ‹å‚æ•°ï¼š
   - **é€’å½’æ‰«æ**: æ˜¯å¦æ‰«æå­æ–‡ä»¶å¤¹
   - **æ£€æµ‹çº¯è‰²å›¾ç‰‡**: æ˜¯å¦æ ‡è®°çº¯è‰²å›¾ç‰‡
   - **å¢å¼ºç›¸ä¼¼åº¦æ£€æµ‹**: æ˜¯å¦å¯ç”¨é«˜çº§æ£€æµ‹ç®—æ³•
   - **å“ˆå¸Œé˜ˆå€¼**: è°ƒæ•´ç›¸ä¼¼åº¦æ•æ„Ÿåº¦ï¼ˆæ•°å€¼è¶Šå°è¶Šä¸¥æ ¼ï¼‰
4. ç‚¹å‡»"å¼€å§‹æ‰«æ"æŒ‰é’®å¼€å§‹æ£€æµ‹

### 3. æŸ¥çœ‹ç»“æœ
1. æ‰«æå®Œæˆåï¼Œåˆ‡æ¢åˆ°"ç»“æœæŸ¥çœ‹"æ ‡ç­¾é¡µ
2. ç¨‹åºä¼šè‡ªåŠ¨åŠ è½½æœ€æ–°çš„æ‰«æç»“æœ
3. ä½¿ç”¨"ä¸Šä¸€ç»„"å’Œ"ä¸‹ä¸€ç»„"æŒ‰é’®æµè§ˆä¸åŒçš„é‡å¤å›¾ç‰‡ç»„
4. å¯¹äºæ¯å¼ å›¾ç‰‡ï¼Œæ‚¨å¯ä»¥ï¼š
   - ğŸ“‹ å¤åˆ¶æ–‡ä»¶è·¯å¾„
   - ğŸ–¼ï¸ æ‰“å¼€å›¾ç‰‡æ–‡ä»¶
   - ğŸ“ æ‰“å¼€æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹

### 4. ä¿å­˜å’ŒåŠ è½½ç»“æœ
- æ‰«æç»“æœä¼šè‡ªåŠ¨ä¿å­˜ä¸ºJSONæ ¼å¼
- å¯ä»¥é€šè¿‡"æ–‡ä»¶"èœå•åŠ è½½ä¹‹å‰çš„æ‰«æç»“æœ
- æ”¯æŒå¯¼å‡ºä¸ºCSVæ ¼å¼ä¾¿äºè¿›ä¸€æ­¥åˆ†æ

## âš™ï¸ å‚æ•°è¯´æ˜

### å“ˆå¸Œé˜ˆå€¼
- **dHashé˜ˆå€¼**: é»˜è®¤12ï¼ŒèŒƒå›´0-64ï¼Œæ•°å€¼è¶Šå°æ£€æµ‹è¶Šä¸¥æ ¼
- **pHashé˜ˆå€¼**: é»˜è®¤4ï¼ŒèŒƒå›´0-64ï¼Œæ•°å€¼è¶Šå°æ£€æµ‹è¶Šä¸¥æ ¼  
- **aHashé˜ˆå€¼**: é»˜è®¤4ï¼ŒèŒƒå›´0-64ï¼Œæ•°å€¼è¶Šå°æ£€æµ‹è¶Šä¸¥æ ¼

### å¢å¼ºç›¸ä¼¼åº¦æ£€æµ‹
- å¯ç”¨åå¯ä»¥æ£€æµ‹æ—‹è½¬ã€ç¼©æ”¾åçš„å›¾ç‰‡
- è®¡ç®—é‡è¾ƒå¤§ï¼Œå¤„ç†æ—¶é—´ä¼šå¢åŠ 
- å»ºè®®åœ¨æ™®é€šæ£€æµ‹æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ä½¿ç”¨

### ç½®ä¿¡åº¦é˜ˆå€¼
- ä»…åœ¨å¢å¼ºç›¸ä¼¼åº¦æ£€æµ‹ä¸­ä½¿ç”¨
- èŒƒå›´0.0-1.0ï¼Œå»ºè®®å€¼0.5-0.8
- æ•°å€¼è¶Šé«˜è¦æ±‚ç›¸ä¼¼åº¦è¶Šé«˜

## ğŸ”§ æ•…éšœæ’é™¤

### ç¨‹åºæ— æ³•å¯åŠ¨
- ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ˜¯64ä½Windows
- å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
- æ£€æŸ¥æ˜¯å¦æœ‰æ€æ¯’è½¯ä»¶è¯¯æŠ¥

### æ‰«æé€Ÿåº¦æ…¢
- å…³é—­å¢å¼ºç›¸ä¼¼åº¦æ£€æµ‹å¯ä»¥æ˜¾è‘—æå‡é€Ÿåº¦
- é€‚å½“æé«˜å“ˆå¸Œé˜ˆå€¼å¯ä»¥å‡å°‘è®¡ç®—é‡
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜

### æ£€æµ‹ç»“æœä¸å‡†ç¡®
- é™ä½å“ˆå¸Œé˜ˆå€¼å¯ä»¥æé«˜æ£€æµ‹ç²¾åº¦
- å¯ç”¨å¢å¼ºç›¸ä¼¼åº¦æ£€æµ‹å¯ä»¥æ‰¾åˆ°æ›´å¤šç›¸ä¼¼å›¾ç‰‡
- è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼æ¥è¿‡æ»¤è¯¯æŠ¥

### å†…å­˜ä¸è¶³
- åˆ†æ‰¹å¤„ç†å¤§é‡å›¾ç‰‡
- å…³é—­å…¶ä»–ä¸å¿…è¦çš„ç¨‹åº
- è€ƒè™‘å‡çº§ç³»ç»Ÿå†…å­˜

## ğŸ“ æ–‡ä»¶è¯´æ˜
- `xImageDuplicateChecker.exe`: ä¸»ç¨‹åºæ–‡ä»¶
- `*.dll`: å¿…éœ€çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶
- `cpp_hash_lib/`: C++åŠ é€Ÿåº“æ–‡ä»¶å¤¹
- `README.txt`: æœ¬è¯´æ˜æ–‡ä»¶
- `LICENSE`: è½¯ä»¶è®¸å¯è¯

## ğŸ”’ éšç§å’Œå®‰å…¨
- æœ¬è½¯ä»¶å®Œå…¨åœ¨æœ¬åœ°è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®
- ä¸ä¼šä¿®æ”¹æˆ–åˆ é™¤æ‚¨çš„å›¾ç‰‡æ–‡ä»¶
- ä»…è¯»å–å›¾ç‰‡æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œä¸ä¼šæ³„éœ²éšç§

## ğŸ“ æŠ€æœ¯æ”¯æŒ
- **GitHubé¡¹ç›®**: https://github.com/ayumilove/xImageDuplicateChecker
- **é—®é¢˜åé¦ˆ**: è¯·åœ¨GitHubä¸Šæäº¤Issue
- **åŠŸèƒ½å»ºè®®**: æ¬¢è¿åœ¨GitHubä¸Šæäº¤Feature Request

## ğŸ“„ ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0
- **å‘å¸ƒæ—¥æœŸ**: {datetime.datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}
- **è®¸å¯è¯**: MIT License

## ğŸ™ è‡´è°¢
æ„Ÿè°¢æ‰€æœ‰ä¸ºè¿™ä¸ªé¡¹ç›®è´¡çŒ®ä»£ç å’Œå»ºè®®çš„å¼€å‘è€…ä»¬ï¼

---
Â© 2024 xImageDuplicateChecker Team
"""
    
    with open(dist_dir / "README.txt", 'w', encoding='utf-8') as f:
        f.write(readme_content)
    print("âœ“ åˆ›å»ºè¯¦ç»†ä½¿ç”¨è¯´æ˜")

def create_zip_package(source_dir, zip_path):
    """åˆ›å»ºZIPå‹ç¼©åŒ…"""
    print(f"åˆ›å»ºå‹ç¼©åŒ…: {zip_path}")
    
    with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
        for file_path in source_dir.rglob('*'):
            if file_path.is_file():
                # è®¡ç®—ç›¸å¯¹è·¯å¾„
                arcname = file_path.relative_to(source_dir.parent)
                zipf.write(file_path, arcname)
                print(f"  æ·»åŠ : {arcname}")
    
    # æ˜¾ç¤ºå‹ç¼©åŒ…å¤§å°
    size_mb = zip_path.stat().st_size / (1024 * 1024)
    print(f"âœ“ å‹ç¼©åŒ…åˆ›å»ºå®Œæˆï¼Œå¤§å°: {size_mb:.1f} MB")

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("xImageDuplicateChecker åˆ†å‘åŒ…åˆ›å»ºå·¥å…·")
    print("=" * 60)
    
    if not create_distribution():
        return False
    
    print("\n" + "=" * 60)
    print("âœ“ åˆ†å‘åŒ…åˆ›å»ºå®Œæˆï¼")
    print("\næ‚¨ç°åœ¨å¯ä»¥ï¼š")
    print("1. å°†releaseç›®å½•ä¸­çš„ZIPæ–‡ä»¶åˆ†äº«ç»™å…¶ä»–ç”¨æˆ·")
    print("2. ç”¨æˆ·è§£å‹åç›´æ¥è¿è¡ŒxImageDuplicateChecker.exe")
    print("3. æ— éœ€å®‰è£…Pythonæˆ–å…¶ä»–ä¾èµ–")
    print("=" * 60)
    
    return True

if __name__ == "__main__":
    try:
        success = main()
        if not success:
            input("\næŒ‰å›è½¦é”®é€€å‡º...")
    except Exception as e:
        print(f"\nå‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        input("\næŒ‰å›è½¦é”®é€€å‡º...")
    
    input("\næŒ‰å›è½¦é”®é€€å‡º...")